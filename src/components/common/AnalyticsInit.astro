---
/**
 * Enhanced Analytics component with business event tracking
 * Tracks user interactions for business insights (form submissions, phone clicks, etc.)
 */

import client from '~/data/client.json';

// Get analytics configuration
const analytics = client.analytics;
const conversionGoals = analytics?.conversionGoals;
const performanceTracking = analytics?.performanceTracking;

// Determine which analytics to load
const hasGA4 = analytics?.googleAnalytics?.enabled && analytics?.googleAnalytics?.measurementId;
const hasGTM = analytics?.googleTagManager?.enabled && analytics?.googleTagManager?.containerId;
const hasFBPixel = analytics?.facebookPixel?.enabled && analytics?.facebookPixel?.pixelId;

// Debug mode for development
const isDebug = import.meta.env.DEV;
---

{/* Enhanced Analytics Initialization Script */}
<script is:inline define:vars={{ 
  conversionGoals, 
  performanceTracking, 
  hasGA4, 
  hasGTM, 
  hasFBPixel, 
  isDebug 
}}>
  // Enhanced Analytics Tracking
  window.AnalyticsTracker = {
    // Track business events
    trackEvent: function(eventName, eventData = {}) {
      if (isDebug) {
        console.log('üìä Analytics Event:', eventName, eventData);
      }

      // Send to Google Analytics 4
      if (hasGA4 && window.gtag) {
        window.gtag('event', eventName, {
          event_category: 'business_interaction',
          event_label: eventData.label || '',
          value: eventData.value || 0,
          ...eventData
        });
      }

      // Send to Google Tag Manager
      if (hasGTM && window.dataLayer) {
        window.dataLayer.push({
          event: eventName,
          eventCategory: 'business_interaction',
          eventAction: eventName,
          eventLabel: eventData.label || '',
          eventValue: eventData.value || 0,
          ...eventData
        });
      }

      // Send to Facebook Pixel
      if (hasFBPixel && window.fbq) {
        window.fbq('track', eventName, eventData);
      }
    },

    // Track phone call clicks
    trackPhoneCall: function(phoneNumber) {
      if (conversionGoals?.phoneCall?.enabled) {
        this.trackEvent(conversionGoals.phoneCall.eventName || 'phone_call_click', {
          label: phoneNumber,
          phone_number: phoneNumber,
          interaction_type: 'phone_call'
        });
      }
    },

    // Track email clicks
    trackEmailClick: function(emailAddress) {
      if (conversionGoals?.emailClick?.enabled) {
        this.trackEvent(conversionGoals.emailClick.eventName || 'email_click', {
          label: emailAddress,
          email_address: emailAddress,
          interaction_type: 'email_click'
        });
      }
    },

    // Track form submissions
    trackFormSubmit: function(formName, formData = {}) {
      if (conversionGoals?.contactForm?.enabled) {
        this.trackEvent(conversionGoals.contactForm.eventName || 'contact_form_submit', {
          label: formName,
          form_name: formName,
          interaction_type: 'form_submission',
          ...formData
        });
      }
    },

    // Track directions clicks
    trackDirectionsClick: function(location) {
      if (conversionGoals?.mapDirections?.enabled) {
        this.trackEvent(conversionGoals.mapDirections.eventName || 'directions_click', {
          label: location,
          location: location,
          interaction_type: 'directions_request'
        });
      }
    },

    // Track page performance
    trackPerformance: function() {
      if (!performanceTracking?.coreWebVitals) return;

      // Core Web Vitals tracking
      if ('web-vital' in window) {
        window.webVitals.getCLS(this.reportWebVital.bind(this));
        window.webVitals.getFID(this.reportWebVital.bind(this));
        window.webVitals.getFCP(this.reportWebVital.bind(this));
        window.webVitals.getLCP(this.reportWebVital.bind(this));
        window.webVitals.getTTFB(this.reportWebVital.bind(this));
      }

      // Page load time tracking
      if (performanceTracking?.pageLoadTimes) {
        window.addEventListener('load', () => {
          setTimeout(() => {
            const navTiming = performance.getEntriesByType('navigation')[0];
            if (navTiming) {
              this.trackEvent('page_load_time', {
                load_time: Math.round(navTiming.loadEventEnd - navTiming.fetchStart),
                dom_content_loaded: Math.round(navTiming.domContentLoadedEventEnd - navTiming.fetchStart),
                first_paint: Math.round(navTiming.responseEnd - navTiming.fetchStart)
              });
            }
          }, 0);
        });
      }
    },

    // Report web vitals
    reportWebVital: function(metric) {
      this.trackEvent('web_vital_' + metric.name.toLowerCase(), {
        metric_name: metric.name,
        metric_value: Math.round(metric.value),
        metric_id: metric.id,
        metric_delta: Math.round(metric.delta)
      });
    },

    // Initialize error tracking
    initErrorTracking: function() {
      if (!performanceTracking?.errorTracking) return;

      window.addEventListener('error', (event) => {
        this.trackEvent('javascript_error', {
          error_message: event.message,
          error_filename: event.filename,
          error_line: event.lineno,
          error_column: event.colno
        });
      });

      window.addEventListener('unhandledrejection', (event) => {
        this.trackEvent('unhandled_promise_rejection', {
          error_message: event.reason?.message || 'Unknown promise rejection',
          error_type: 'promise_rejection'
        });
      });
    }
  };

  // Initialize tracking when DOM is ready
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize performance tracking
    window.AnalyticsTracker.trackPerformance();
    
    // Initialize error tracking
    window.AnalyticsTracker.initErrorTracking();

    // Auto-track phone number clicks
    document.addEventListener('click', function(event) {
      const target = event.target.closest('a[href^="tel:"]');
      if (target) {
        const phoneNumber = target.href.replace('tel:', '');
        window.AnalyticsTracker.trackPhoneCall(phoneNumber);
      }
    });

    // Auto-track email clicks
    document.addEventListener('click', function(event) {
      const target = event.target.closest('a[href^="mailto:"]');
      if (target) {
        const emailAddress = target.href.replace('mailto:', '');
        window.AnalyticsTracker.trackEmailClick(emailAddress);
      }
    });

    // Auto-track directions clicks
    document.addEventListener('click', function(event) {
      const target = event.target.closest('a[href*="maps.google.com"], .directions-btn');
      if (target) {
        const location = target.getAttribute('data-location') || 'primary';
        window.AnalyticsTracker.trackDirectionsClick(location);
      }
    });

    // Auto-track form submissions
    document.addEventListener('submit', function(event) {
      const form = event.target;
      if (form.tagName === 'FORM') {
        const formName = form.getAttribute('name') || form.id || 'unnamed_form';
        const formData = {};
        
        // Collect form data (non-sensitive fields only)
        const formElements = form.elements;
        for (let element of formElements) {
          if (element.name && element.type !== 'password' && element.type !== 'hidden') {
            formData[element.name] = element.type === 'email' ? 'provided' : 'filled';
          }
        }
        
        window.AnalyticsTracker.trackFormSubmit(formName, formData);
      }
    });

    if (isDebug) {
      console.log('üîç Enhanced Analytics Tracking Initialized');
      console.log('üìä Conversion Goals:', conversionGoals);
      console.log('‚ö° Performance Tracking:', performanceTracking);
    }
  });
</script>

{/* Load web-vitals library for Core Web Vitals tracking */}
{performanceTracking?.coreWebVitals && (
  <script async src="https://unpkg.com/web-vitals@3/dist/web-vitals.attribution.iife.js"></script>
)}

{/* Development mode indicator */}
{isDebug && (hasGA4 || hasGTM || hasFBPixel) && (
  <div class="fixed bottom-4 right-4 bg-blue-600 text-white text-xs px-3 py-2 rounded-lg shadow-lg z-50 font-mono">
    üìä Analytics Debug Mode
  </div>
)}

<style>
  /* Ensure analytics debug indicator is visible */
  [data-analytics-debug] {
    pointer-events: none;
    user-select: none;
  }
</style>