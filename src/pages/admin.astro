---
/**
 * Admin page for Decap CMS (formerly Netlify CMS)
 * Provides a content management interface for non-technical users
 */

import LoadingSpinner from '~/components/ui/LoadingSpinner.astro';

const metadata = {
  title: 'Admin Panel - Content Management',
  description: 'Content management system for website administration',
  robots: {
    index: false,
    follow: false,
  },
};
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{metadata.title}</title>
    <meta name="description" content={metadata.description} />
    <meta name="robots" content="noindex, nofollow" />
    <meta name="googlebot" content="noindex, nofollow" />

    <!-- Decap CMS Styles -->
    <link rel="stylesheet" href="/admin/decap-preview-styles.css" />

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  </head>
  <body>
    <!-- Decap CMS Admin Interface -->
    <div id="nc-root"></div>

    <!-- Loading Indicator -->
    <div id="cms-loading">
      <LoadingSpinner message="Loading Content Management System..." />
    </div>

    <!-- Error Container -->
    <div id="cms-error" class="error-container hidden">
      <div class="error-content">
        <h2>Failed to Load CMS</h2>
        <p>There was an error loading the content management system.</p>
        <p class="error-hint">Please check your internet connection and try again.</p>
        <button id="retry-button" class="retry-button">Retry</button>
      </div>
    </div>

    <style>
      /* Base styles */
      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
      }

      #nc-root {
        height: 100vh;
      }

      /* Loading state */
      .cms-loaded #cms-loading {
        display: none;
      }

      /* Error styles */
      .error-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #f8f9fa;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
      }

      .error-container.hidden {
        display: none;
      }

      .error-content {
        text-align: center;
        color: #dc3545;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      }

      .error-content h2 {
        margin-bottom: 16px;
      }

      .error-content p {
        margin: 8px 0;
      }

      .error-hint {
        font-size: 14px;
        color: #6c757d;
      }

      .retry-button {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        margin-top: 16px;
        font-size: 14px;
      }

      .retry-button:hover {
        background: #0056b3;
      }
    </style>

    <!-- Decap CMS Script -->
    <script>
      // Type declarations for Decap CMS
      declare global {
        interface Window {
          CMS?: {
            registerPreviewStyle: (url: string) => void;
            registerPreviewTemplate: (name: string, template: unknown) => void;
          };
        }
      }

      // Import Decap CMS
      // @ts-expect-error - External CDN module without type definitions
      import('https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js')
        .then(() => {
          // Hide loading indicator
          document.body.classList.add('cms-loaded');

          // Initialize CMS
          if (window.CMS) {
            // Custom preview styles
            window.CMS.registerPreviewStyle('/admin/decap-preview-styles.css');

            // Custom preview templates can be registered here
            // Example: window.CMS.registerPreviewTemplate('blog', BlogPreview);

            console.log('‚úÖ Decap CMS loaded successfully');
          }
        })
        .catch((error) => {
          console.error('‚ùå Failed to load Decap CMS:', error);

          // Hide loading, show error
          const loadingEl = document.getElementById('cms-loading');
          const errorEl = document.getElementById('cms-error');

          if (loadingEl) loadingEl.style.display = 'none';
          if (errorEl) errorEl.classList.remove('hidden');
        });

      // Retry button handler
      document.addEventListener('DOMContentLoaded', () => {
        const retryButton = document.getElementById('retry-button');
        if (retryButton) {
          retryButton.addEventListener('click', () => {
            window.location.reload();
          });
        }
      });
    </script>

    <!-- Development mode indicator -->
    <script>
      if (import.meta.env.DEV) {
        console.log('üîß CMS Admin Panel - Development Mode');
        console.log('üìÅ Config file: /public/admin/config.yml');
        console.log('üé® Preview styles: /public/admin/decap-preview-styles.css');
      }
    </script>
  </body>
</html>
